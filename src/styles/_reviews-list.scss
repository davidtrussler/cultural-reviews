$image-size: 61px;
$image-size-xs: 77px;
$image-size-s: 95px;
$image-size-sm: 113px;
$image-size-m: 162px;
$image-size-lm: 182px;
$image-size-l: 207px;

$image-size-aligned: calc((100% - ($gutter * 3)) / 4);
$image-size-stacked: calc((100% - ($gutter * 2)) / 2);
$image-size-aligned-2-col: calc((100% - ($gutter * 2)) / 2);

@mixin listingImage($imageSize, $layout) {
  width: $imageSize;
  height: $imageSize;
  padding: 0;

  @if $layout == aligned {
    margin-bottom: 0;
  } @else {
    margin-bottom: 0.25rem;
  }

  @supports(display: grid) {
    @if $layout == aligned {
      width: 100%;
      height: 0;
      padding: 0 0 100%;
    } @else {
      width: $image-size-stacked;
      height: 0;
      padding-bottom: $image-size-stacked;
    }
  }
}

.reviews {
  position: relative; 
  margin: 1rem 0 0;

  .reviews__listing {
    @include clearfix;

    margin: 0;
    padding: 0 0 0.5rem;

    @include respond-to($mq-s) {
      padding-bottom: 0.75rem;
    }

    @include respond-to($mq-m) {
      padding-bottom: 1rem;
    }

    &:last-child {
      padding-bottom: 0;
    }
  }

  .listing__item {
    display: -ms-grid;
    -ms-grid-columns: $image-size auto;;
    display: grid;
    grid-template-columns: $image-size-aligned auto;

    column-gap: $gutter;
    text-decoration: none;
  }

  .listing__image {
    -ms-grid-column: 1;
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;

    @include listingImage($image-size, aligned);
  }

  .listing__content {
    -ms-grid-column: 2;
  }

  .content__medium {
    @include medium;
  }

  .content__title {
    @include title;
  }

  .content__extra {
    @include extra;
  }

  /* Responsive layout
   * Baseline: 1 column, image/content aligned, image size: default
  **/

  @include respond-to($mq-xs) {
    // 2 columns, image/content stacked
    .reviews__list {
      display: flow-root;

      @supports(display:flow-root) {
        &:after {
          content: '';
          position: absolute;
          border-right: solid 1px $colour-grey-light;
          left: calc(50% - 0.5px);
          top: -0.125rem;
          bottom: -0.125rem;
        }
      }
    }

    .reviews__listing {
      display: inline-block;
      float: left;
      width: calc((100% - $gutter) / 2);

      &:nth-child(2n) {
        margin: 0 0 0 calc($gutter / 2);
      }

      &:nth-child(2n+1) {
        margin: 0 calc($gutter / 2) 0 0;
        clear: left;
      }

      &:nth-last-child(2) {
        padding-bottom: 0;
      }
    }

    .listing__item {
      display: inline;
    }

    .listing__image {
      @include listingImage($image-size-xs, stacked);
    }
  }

  @include respond-to($mq-s) {
    // 2 columns, image/content stacked, image size: s
    .listing__image {
      @include listingImage($image-size-s, stacked);
    }
  }

  @include respond-to($mq-sm) {
    // 2 columns, image/content aligned, image size: s
    .listing__item {
      display: -ms-grid;
      -ms-grid-columns: $image-size-sm auto;
      display: grid;
      grid-template-columns: $image-size-aligned-2-col auto;
      column-gap: calc($gutter * 2);
    }

    .listing__image {
      @include listingImage($image-size-sm, aligned);
    }

    .listing__content {
      -ms-grid-column: 2;
      -ms-grid-row: 1;
    }
  }

  @include respond-to($mq-m) {
    // 2 columns, image/content aligned, image size: m
    .listing__item {
      -ms-grid-columns: $image-size-m auto;
    }

    .listing__image {
      @include listingImage($image-size-m, aligned);
    }
  }

  @include respond-to($mq-lm, portrait) {
    // 2 columns, image/content aligned, image size: lm
    .listing__item {
      -ms-grid-columns: $image-size-lm auto;
    }

    .listing__image {
      @include listingImage($image-size-lm, aligned);
    }
  }

  @include respond-to($mq-l, portrait) {
    // 2 columns, image/content aligned, image size: l
    .listing__item {
      // display: -ms-grid;
      -ms-grid-columns: $image-size-l auto;
    }

    .listing__image {
      @include listingImage($image-size-l, aligned);
    }
  }

  @include respond-to($mq-lm, landscape) {
    // 4 columns, image/content stacked, image size: lm
    @supports(display:flow-root) {
      &:before {
        content: '';
        position: absolute;
        border-right: solid 1px $colour-grey-light;
        left: calc(((100% - ($gutter * 3)) / 4) + ($gutter / 2) - 0.5px);
        top: -0.125rem;
        bottom: -0.125rem;
      }

      &:after {
        content: '';
        position: absolute;
        border-left: solid 1px $colour-grey-light;
        right: calc(((100% - ($gutter * 3)) / 4) + ($gutter / 2) - 0.5px);
        top: -0.125rem;
        bottom: -0.125rem;
      }
    }

    .reviews__listing {
      width: calc((100% - ($gutter * 3)) / 4);

      &:nth-child(4n) {
        margin: 0 0 0 calc($gutter / 2);
      }

      &:nth-child(4n+1) {
        margin: 0 calc($gutter / 2) 0 0;
        clear: left;
      }

      &:nth-child(4n+2) {
        margin: 0 calc($gutter / 2);
      }

      &:nth-child(4n+3) {
        margin: 0 calc($gutter / 2);
        clear: none;
      }

      &:nth-last-child(3),
      &:nth-last-child(4) {
        padding-bottom: 0;
      }
    }

    .listing__item {
      display: inline;
    }

    .listing__image {
      @include listingImage($image-size-lm, stacked);

      @supports(display:grid) {
        width: 100%;
        height: 0;
        padding: 0 0 100%;
      }
    }
  }

  @include respond-to($mq-l, landscape) {
    // 4 columns, image/content overlap, image size: l
    .listing__item {
      display: grid;
      grid-template-columns: none;
      grid-template-rows: 1fr auto 1rem;
    }

    .listing__image {
      @include listingImage($image-size-l, stacked);
    }

    @supports(grid-column: 1 / 2) {
      .listing__content {
        grid-column: 1 / 2;
        grid-row: 2 / 4;
      }

      .content__wrapper {
        display: inline-block;
        padding: 0.5rem calc($gutter * 2);
        margin: 0 calc($gutter * 4);
        background: rgba(224, 224, 224, 0.875);
      }

      .listing__image {
        width: 100%;
        height: 0;
        padding: 0 0 100%;
        grid-column: 1 / 2;
        grid-row: 1 / 3;
      }
    }
  }
}
